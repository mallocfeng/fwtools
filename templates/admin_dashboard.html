<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>管理员订阅管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;700;800&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#edf2f7;--ink:#1a2738;--muted:#55667f;--paper:#ffffff;--line:#d8e0ea;--primary:#1f5ec3;--danger:#cc4a4a;--warn:#b88131;--ok:#137a56}
    *{box-sizing:border-box}
    body{margin:0;font-family:"IBM Plex Sans",sans-serif;background:radial-gradient(circle at 0 0,#d7e2fa 0,#edf2f7 45%),linear-gradient(120deg,#eef2f8,#edf2f7);color:var(--ink);padding:20px}
    .wrap{max-width:1320px;margin:0 auto}
    .head{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .title{margin:0;font-family:"Manrope",sans-serif;font-weight:800;font-size:40px}
    .sub{margin:4px 0 0;color:var(--muted)}
    .ctl{display:flex;align-items:center;gap:10px}
    .search{padding:9px 12px;border:1px solid #cfd9e6;border-radius:10px;min-width:260px;background:#fff}
    button{border:none;border-radius:11px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-main{background:var(--primary);color:#fff}
    .btn-main:disabled{opacity:.6;pointer-events:none}
    .panel{background:var(--paper);border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(28,43,64,.09)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:12px 10px;border-bottom:1px solid #ecf0f5;text-align:left}
    .table th{font-family:"Manrope",sans-serif;font-size:15px;background:#f8fafd}
    .url{max-width:180px;display:inline-block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#2a64bf}
    .tag{padding:3px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .on{color:#0f6f4f;background:#e4f5ee}
    .off{color:#7b4d17;background:#fff1dc}
    .online{color:#0f6f4f;background:#e4f5ee}
    .offline{color:#6a7588;background:#e9eef5}
    .ops{display:flex;gap:6px;flex-wrap:nowrap;white-space:nowrap;align-items:center}
    .ops button{padding:6px 9px;font-size:12px}
    .b-disable{background:var(--warn);color:#fff}
    .b-enable{background:var(--ok);color:#fff}
    .b-delete{background:var(--danger);color:#fff}
    .b-block{background:#9d3a3a;color:#fff}
    .b-unblock{background:#3f6fbe;color:#fff}
    .loading{display:none;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="head">
      <div>
        <h2 class="title">管理员订阅管理</h2>
        <p class="sub">每次刷新都会先和 3x-ui 自动同步，再展示最新状态</p>
      </div>
      <div class="ctl">
        <input id="searchInput" class="search" placeholder="搜索注册用户/邮箱/SubID" oninput="renderRows()"/>
        <button id="refreshBtn" class="btn-main" onclick="load()">刷新并同步</button>
        <span id="loadingText" class="loading">加载中，请稍候...</span>
      </div>
    </header>

    <section class="panel">
      <table class="table">
        <thead>
          <tr>
            <th>注册用户</th><th>用户状态</th><th>节点备注</th><th>Client Email</th><th>Sub ID</th><th>订阅地址</th><th>开关状态</th><th>在线状态</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </div>

<script>
async function act(id,type){
  const r=await fetch('/api/admin/services/'+id+'/'+type,{method:'POST'});
  const d=await r.json();
  if(!d.success)return alert(d.msg||'失败');
  load();
}
async function userAct(uid,type){
  const r=await fetch('/api/admin/users/'+uid+'/'+type,{method:'POST'});
  const d=await r.json();
  if(!d.success)return alert(d.msg||'失败');
  load();
}
function clearMasks(){document.querySelectorAll('.ant-modal-mask,.modal-backdrop,.el-overlay,.v-overlay,.layui-layer-shade').forEach(e=>e.remove())}
const rowsEl=document.getElementById('rows');
const refreshBtn=document.getElementById('refreshBtn');
const loadingText=document.getElementById('loadingText');
const searchInput=document.getElementById('searchInput');
let allRows=[];
function stateTag(v,yes,no,yesCls,noCls){return `<span class="tag ${v?yesCls:noCls}">${v?yes:no}</span>`}
function renderRows(){
  const kw=(searchInput.value||'').trim().toLowerCase();
  const rows=kw?allRows.filter(x=>{
    const a=(x.userEmail||'').toLowerCase();
    const b=(x.clientEmail||'').toLowerCase();
    const c=(x.clientSubID||'').toLowerCase();
    return a.includes(kw)||b.includes(kw)||c.includes(kw);
  }):allRows;
  rowsEl.innerHTML=(rows||[]).map(x=>`<tr>
      <td>${x.userEmail||'-'}</td>
      <td>${x.userID>0?stateTag(!x.userBlocked,'正常','已拉黑','on','off'):'-'}</td>
      <td>${x.nodeRemark||('-#'+x.inboundID)}</td>
      <td>${x.clientEmail}</td>
      <td>${x.clientSubID}</td>
      <td><a class='url' href='${x.subscriptionURL||''}' target='_blank'>${x.subscriptionURL||''}</a></td>
      <td>${stateTag(x.enabled,'启用','暂停','on','off')}</td>
      <td>${stateTag(x.online,'在线','离线','online','offline')}</td>
      <td><div class='ops'><button class='b-disable' onclick='act(${x.id},"disable")'>停用</button><button class='b-enable' onclick='act(${x.id},"enable")'>启用</button><button class='b-delete' onclick='act(${x.id},"delete")'>删除</button>${x.userID>0?(x.userBlocked?`<button class='b-unblock' onclick='userAct(${x.userID},"unblock")'>解封</button>`:`<button class='b-block' onclick='userAct(${x.userID},"block")'>拉黑</button>`):''}</div></td>
    </tr>`).join('');
}
async function load(){
  refreshBtn.disabled=true;loadingText.style.display='inline';
  try{
    const r=await fetch('/api/admin/services');
    const d=await r.json();
    if(!d.success)return alert(d.msg||'失败');
    allRows=d.obj||[];
    renderRows();
  }finally{
    refreshBtn.disabled=false;loadingText.style.display='none';
  }
}
clearMasks();setInterval(clearMasks,1000);load();
</script>
</body>
</html>
